# Usage Guide

Complete guide to installing, configuring, and using MacroManAtlas.

## Prerequisites

MacroManAtlas hooks are bash scripts that require a POSIX-compatible environment.

### Required Tools

| Tool | Version | Purpose |
|------|---------|---------|
| **bash** | 4.0+ | Hook script execution |
| **jq** | 1.6+ | JSON parsing (hook input) |
| **flock** | any | Module-level concurrency locks |

### Installation by OS

**macOS:**

```bash
brew install jq
brew install flock    # Not included by default on macOS
```

**Ubuntu / Debian:**

```bash
sudo apt install jq util-linux   # flock is in util-linux
```

**Fedora / RHEL:**

```bash
sudo dnf install jq util-linux
```

**Windows:**

Windows does not natively support bash. You need one of:

- **WSL 2** (recommended): Install Ubuntu from the Microsoft Store, then install `jq` inside WSL. Claude Code must run within WSL for hooks to fire.
- **Git Bash (MSYS2)**: Ships with Git for Windows. Install `jq` via `pacman -S jq` in the MSYS2 terminal. Ensure `flock` is available or install `util-linux` from MSYS2 packages.
- **Cygwin**: Install `bash`, `jq`, and `util-linux` packages during setup.

Verify your environment:

```bash
bash --version
jq --version
flock --version 2>/dev/null || echo "flock not found"
```

## Installation

```bash
# Add the marketplace
claude plugin marketplace add MacroMan5/macromanatlas

# Install the plugin
claude plugin install macromanatlas@macromanatlas-marketplace
```

This registers the plugin and its hooks. No additional configuration is needed.

## First Run

### `/index-init`

Run this command inside any Claude Code session to initialize the index:

```
/index-init
```

This will:

1. Detect your project type (CMake, Cargo, Go, Node, etc.)
2. Discover all modules/packages/directories
3. Generate a `README.md` inside each module (with file listings, tags, descriptions)
4. Create `.claude/index.md` (full index with cross-references)
5. Create `.claude/index.summary.md` (compact <4 KB summary for context injection)

The process takes 30 seconds to a few minutes depending on repository size.

### Using `--gitignore`

If you don't want to commit the index files to version control:

```
/index-init --gitignore
```

This appends the following to your `.gitignore`:

```
# MacroManAtlas index (auto-generated)
.claude/index.md
.claude/index.summary.md
```

Per-module READMEs are **not** gitignored since they are useful for human developers too.

## Understanding the Output

### Two-Level Index

MacroManAtlas maintains two index files:

| File | Size | Purpose |
|------|------|---------|
| `.claude/index.md` | Full | Complete cross-reference of all modules, files, tags, and dependencies. Stored on disk for the sync daemon. |
| `.claude/index.summary.md` | <4 KB | Compact summary injected into Claude's context at session start and before compaction. |

The summary is a trimmed projection of the full index -- module table, key files, and tag overview. It gives Claude enough to navigate without consuming the context window.

### Per-Module READMEs

Each module gets a `README.md` with two sections:

```markdown
<!-- AUTO-GENERATED by MacroManAtlas -- do not edit above this line -->
# ModuleName

Purpose description.

## Files
| File | Tags | Description |
|------|------|-------------|
| src/Foo.cpp | core, logic | Main processing loop |

## Dependencies
- library-name

## Public API
- `ClassName` -- brief description
<!-- AUTO-GENERATED end -->

<!-- CUSTOM -->
Your permanent notes go here. This section is never overwritten.
<!-- /CUSTOM -->
```

**Rules:**
- Everything between `<!-- AUTO-GENERATED ... -->` and `<!-- AUTO-GENERATED end -->` is regenerated on each sync.
- Everything between `<!-- CUSTOM -->` and `<!-- /CUSTOM -->` is preserved across all rebuilds and syncs.

## Commands Reference

### `/index-init [--gitignore]`

Initialize the index for the current repository.

| Flag | Effect |
|------|--------|
| `--gitignore` | Add index files to `.gitignore` |

**When to use:** First time setup, or after cloning a repo that doesn't have an index yet.

### `/index-status`

Display the current index state:

- Project type detected
- Number of modules and files indexed
- Last full rebuild timestamp
- Last sync timestamp per module
- Any modules with stale or missing READMEs

**When to use:** To check if the index is up to date before starting work.

### `/index-rebuild [--module <name>] [--m "<instructions>"]`

Rebuild the index (full or partial).

| Flag | Effect |
|------|--------|
| `--module <name>` | Rebuild only the specified module |
| `--m "<instructions>"` | Pass custom instructions to the rebuild agent |

**Examples:**

```bash
# Full rebuild of all modules
/index-rebuild

# Rebuild only the Tracking module
/index-rebuild --module MacroMan-Tracking

# Rebuild with emphasis on interface documentation
/index-rebuild --m "Focus on public API surfaces and interface contracts"

# Rebuild one module with custom instructions
/index-rebuild --module Core --m "Include threading safety notes for each class"
```

**When to use:** After major refactors, branch switches, or when the index feels stale.

## The CUSTOM Section

Each module README has a `<!-- CUSTOM -->` block at the bottom. Use it for:

- Architecture notes that don't belong in code comments
- Migration warnings
- Team-specific conventions
- Links to design documents

Example:

```markdown
<!-- CUSTOM -->
## Notes

- This module is performance-critical. All changes must pass the <1ms budget.
- The IDetector interface is frozen for v2.0. Propose changes in a design doc first.
- See https://wiki.internal/detection-pipeline for the architecture diagram.
<!-- /CUSTOM -->
```

This content survives all rebuilds and syncs. You can edit it freely.

## How Auto-Sync Works

After initialization, MacroManAtlas keeps the index updated automatically:

1. **Trigger:** Every time Claude uses the `Write` or `Edit` tool, the `PostToolUse` hook fires.
2. **Path extraction:** The hook reads the `file_path` from the structured tool input (no Bash output parsing -- this is a deliberate design choice for reliability).
3. **Module detection:** The first path component determines the affected module.
4. **Debounce:** A 30-second cooldown per module prevents redundant updates. If the same module was synced <30 seconds ago, the hook exits silently.
5. **Lock:** `flock -n` acquires a non-blocking lock for the module. If another sync is already running for that module, the hook exits.
6. **Daemon:** A background `claude -p` process reads the module README, updates file listings and descriptions, and regenerates the summary. It is restricted to `Read`, `Write`, `Edit`, `Glob`, and `Grep` tools only, with a maximum of 10 turns.
7. **Atomic write:** The daemon writes to a temp file first, then moves it into place to prevent corruption.

### Why only Write/Edit?

The hook intentionally does **not** trigger on `Bash` tool calls. Parsing shell command output to determine which files changed is fragile and error-prone. By limiting to structured tool inputs (`Write.file_path`, `Edit.file_path`), the hook reliably knows exactly which file was affected.

If you create files via Bash (e.g., `mkdir`, `touch`, scaffolding scripts), run `/index-rebuild` afterward to pick them up.

## Security

MacroManAtlas takes several precautions:

- **Excluded files:** `.env*`, `.git/`, `*.key`, `*.pem`, `.npmrc`, `.pypirc`, `.aws/`, `.ssh/`, `credentials`, `secrets`, `token` files are never read or indexed.
- **Path sanitization:** Backslash normalization, path traversal blocking (`../`), and dangerous character stripping.
- **Tool restriction:** The background daemon can only use `Read`, `Write`, `Edit`, `Glob`, and `Grep` -- no `Bash`, no network access.
- **Prompt constraints:** The daemon prompt explicitly forbids modifying source code.

## Troubleshooting

### Hooks not firing

1. Verify the plugin is installed: `claude plugin list`
2. Check that hooks are registered: look for `macromanatlas` in Claude's hook output at session start.
3. Ensure `bash` and `jq` are on your PATH.
4. On Windows, verify you're running inside WSL or Git Bash.

### Stale index

If the index doesn't reflect recent changes:

1. Check debounce: the sync daemon waits 30 seconds between updates to the same module. Wait and check again.
2. Check locks: `ls /tmp/.macromanatlas-*/` to see if lockfiles exist. Stale locks may block syncs -- delete them if the process is gone.
3. Run `/index-rebuild` to force a full refresh.

### Daemon logs

The sync daemon logs to:

```
~/.claude/logs/index-sync.log
```

Check this file for errors if modules aren't updating. Common issues:

- `flock: command not found` -- install `util-linux` or `flock`
- `jq: command not found` -- install `jq`
- Permission errors on `/tmp` lockfiles

### flock issues

**macOS:** `flock` is not included by default. Install via Homebrew:

```bash
brew install flock
```

**Docker / minimal containers:** The `util-linux` package may not be installed. Add it to your Dockerfile:

```dockerfile
RUN apt-get update && apt-get install -y util-linux jq
```

### Windows: WSL / Git Bash setup

1. **WSL 2:** Install from Microsoft Store. Open a WSL terminal and install dependencies:
   ```bash
   sudo apt update && sudo apt install jq util-linux
   ```
   Run Claude Code from within the WSL terminal.

2. **Git Bash:** Open Git Bash and verify:
   ```bash
   which bash && which jq && which flock
   ```
   If `jq` is missing, download the binary from [jqlang.github.io/jq](https://jqlang.github.io/jq/) and place it on your PATH.

## Uninstalling

1. Remove the plugin:
   ```bash
   claude plugin uninstall macromanatlas
   ```

2. Optionally delete generated index files:
   ```bash
   rm -f .claude/index.md .claude/index.summary.md
   ```

3. Optionally delete per-module README auto-generated sections (the CUSTOM sections are yours to keep).

4. Clean up temp files:
   ```bash
   rm -rf /tmp/.macromanatlas-*
   ```

5. Remove log file:
   ```bash
   rm -f ~/.claude/logs/index-sync.log
   ```
